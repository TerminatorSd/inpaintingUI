<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
    <title>img inpainting</title>
    <script src="./jquery.min.js"></script>
    <style>
        #canvas_draw{
            margin: 0px;
            /*border: 1px solid grey;*/
            /*background-color: #FFFFF0;*/
        }
        img {
          position: absolute;
          z-index: -1;
         /* max-width: 500px;
          height: auto;*/
        }
    </style>
</head>
<body style="margin:0px;">
  <input id="img_upload" type="file"/><br>
  <img id="img_show" src="img.jpeg" alt=""/>
  <div>
      <canvas id="canvas_draw" width="360px" height="360px"></canvas>
  </div>
  <div>
      <button id="clear_all">清空</button>
      <button id="inpaint">复原</button>
      <button id="mask">mask</button>
  </div>
</body>
<script>

    setCanvasSizeAndListener();

    // 图片选择预览
    $('#img_upload').change(function(){  
      var objUrl = getObjectURL(this.files[0]);

      //获取文件信息  
      // console.log('objUrl = '+ objUrl);  
      if (objUrl) {  
        $('#img_show').attr('src', objUrl);  
        setTimeout(function() {
          setCanvasSizeAndListener();
        }, 0);
      }   
    }); 

    function getObjectURL(file) {  
      var url = null;   
      if(window.createObjectURL != undefined) {  
        url = window.createObjectURL(file) ;  
      } else if (window.URL != undefined) { 
        // mozilla(firefox)  
        url = window.URL.createObjectURL(file) ;  
      } else if (window.webkitURL != undefined) { 
        // webkit or chrome  
        url = window.webkitURL.createObjectURL(file) ;  
      }  
      return url;  
    }  

    function setCanvasSizeAndListener() {
      // 获取canvas 对象
      var canvas_dom = document.getElementById('canvas_draw');
      var ctx = canvas_dom.getContext('2d');  

      // 获取上传图片宽高
      var img = new Image();
      var imgDom = document.getElementById('img_show');
      img.src = imgDom.src;

      //获取canvas上下文，设置宽高及清空
      canvas_dom.width = img.width;
      canvas_dom.height = img.height;

      // 添加清除功能
      $('#clear_all').click(function(){
          canvas_dom.height = canvas_dom.height;
      });

      // 产生遮罩功能
      $('#mask').click(function() {
        var image = canvas_dom.toDataURL("image/png");  
        var w = window.open('about:blank','image from canvas');  
        w.document.write("<img src='" + image + "' alt='from canvas'/>");  
      }) 

      //用来判断鼠标是否还在按下
      var down_flag = false;

      //监听事件
      $('canvas').mousedown(function(e){
        //鼠标按下时的事件
        down_flag = true;
        var ev = ev || window.event;
        ctx.moveTo(ev.clientX - canvas_dom.offsetLeft, ev.clientY - canvas_dom.offsetTop);
        ctx.strokeStyle = 'red';
        ctx.lineWidth = 10;
      }).mouseup(function(e){
        //鼠标抬起事件
        down_flag = false;
      }).mousemove(function(e){
        //鼠标移动事件
        if(down_flag) {
          var ev = ev || window.event;
          ctx.lineTo(ev.clientX - canvas_dom.offsetLeft, ev.clientY - canvas_dom.offsetTop);
          ctx.stroke();
        }
      })
    }

</script>
</html>